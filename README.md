# JWT Authentication Demo

This project showcases usage of JWT in asp.net Core application.

It was following this guide:
- [Part I](https://goblincoding.com/2016/07/03/issuing-and-authenticating-jwt-tokens-in-asp-net-core-webapi-part-i/)
- [Part II](https://goblincoding.com/2016/07/07/issuing-and-authenticating-jwt-tokens-in-asp-net-core-webapi-part-ii/)

It was supported by these sources:
- ["JWT- sub" is equivalent to ".net - nameidentifier", what is it?](http://stackoverflow.com/questions/5814017/what-is-the-purpose-of-nameidentifier-claim)
- [Getting current user Id](http://stackoverflow.com/questions/38751616/asp-net-core-identity-get-current-user)
- [Adding roles](http://stackoverflow.com/questions/42036810/asp-net-core-jwt-mapping-role-claims-to-claimsidentity)
    - Proceed with caution, roles should be added with normal string "role" not using ClaimTypes.Role. It still works but takes more space and may not be compatible with server that is not asp.net core.

# Migrations in ClassLib

To keep migraitons in class library there are few way to achieve it. Here are some materials on it:
- [jonsagara commented on 31 Jul 2016](https://github.com/aspnet/EntityFramework/issues/5320#issuecomment-236395136)
- [dotnet ef documentation](https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet#targeting-class-library-projects-is-not-supported)

It is done by usage of attributes, as seen on example below:
```
dotnet ef --project ../MyProject.Entities --startup-project . migrations add MyNewMigration
dotnet ef --project ../MyProject.Entities --startup-project . database update
```
- `--project` should point to the project where we want migrations to be stored
- `--startup-project` should point to executable project (eg. Server project, the one with startup class)
- the attribute that relates to the project we are in can be ommited


## Proposed way to do it:

1. Enable `dotnet ef` tools in ClassLib, by adding dependencies to `<ClassLibName>.csproj` file:
```xml
<ItemGroup>
    <DotNetCliToolReference Include="Microsoft.EntityFrameworkCore.Tools.DotNet" Version="1.0.0" />
</ItemGroup>
```
2. In terminal enter ClassLib location: `cd <ClassLibName>`
3. To add migrations:
```
dotnet ef --startup-project ../Server migrations add <MigrationName>
```
4. To update database
```
dotnet ef --startup-project ../Server migrations add <MigrationName>
```
5. In Server project in Startup Class in ConfigureServices method add context in following way:
```cs
services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlite(Configuration.GetConnectionString("DefaultConnection"), 
        b => b.MigrationsAssembly("DataAccessLayer")));
```
Where in place of "DataAccessLayer" type namespace of your ClassLib containing migrations.

## Adding SQLite database

There seems to be problem with autogenerated connection string which looks like that:
```json
"ConnectionStrings": {
    "DefaultConnection": "DataSource=.\\dotnet-jwt-auth.db"
}
```
For some reason it doesn't work, quick fix is to change it to something like that:
```json
"ConnectionStrings": {
    "DefaultConnection": "DataSource=dotnet-jwt-auth.db"
}
```